name: Update Domain Rule Count Badge Data

on:
  push:
    branches:
      - main # 当 main 分支有新的 push 时触发
    paths:
      - 'config.json' # 当 config.json 有变化时触发
      - 'count_rules.py' # 当脚本有变化时触发
  schedule:
    - cron: '0 */2 * * *' # 每两小时更新一次 UTC 时间

  workflow_dispatch: # 允许手动触发 (可选)

jobs:
  update_data:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    # <--- 新增步骤：安装 CJK 字体 --->
    - name: Install CJK fonts
      uses: RisingInIris2017/cjk-fonts-action@v1 # 使用这个 Action 来安装字体
      # 你可以查看该 Action 的文档看是否有参数可以指定安装的字体类型或语言，通常默认参数会安装常用 CJK 字体

    - name: Install dependencies # <--- 保持这个步骤，安装 Python 库
      run: |
        python -m pip install --upgrade pip
        pip install requests matplotlib numpy

    - name: Run script to count rules, log history, and generate chart image # <--- 这个步骤现在可以依赖上面安装好的字体了
      run: python count_rules.py config.json

    - name: Deploy badge data, history, and chart image to gh-pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: badge_data # 这个目录名称和脚本中的一致
        publish_branch: gh-pages
        # cname: your-domain.com # 如果你的 GitHub Pages 使用了自定义域名，取消注释并替换
        # destination_dir: / # 默认就是发布到 gh-pages 分支的根目录
        title: Update domain rules count, history, and chart image # 修改 commit 标题
